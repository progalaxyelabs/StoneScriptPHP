#!/usr/bin/env php
<?php
/**
 * StoneScriptPHP CLI Tool
 * Like 'php artisan' for Laravel or 'ng' for Angular
 *
 * Usage: php stone <command> [options]
 */

// Detect installation mode and set up paths
if (strpos(__DIR__, 'vendor/progalaxyelabs/stonescriptphp') !== false) {
    // Running directly from vendor/progalaxyelabs/stonescriptphp/stone
    $frameworkDir = __DIR__;
    $projectRoot = dirname(__DIR__, 3);
    $isVendorMode = true;
} elseif (is_dir(__DIR__ . '/vendor/progalaxyelabs/stonescriptphp')) {
    // stone was copied to project root by composer post-install
    $frameworkDir = __DIR__ . '/vendor/progalaxyelabs/stonescriptphp';
    $projectRoot = __DIR__;
    $isVendorMode = true;
} else {
    // Running from framework development repository
    $frameworkDir = __DIR__;
    $projectRoot = __DIR__;
    $isVendorMode = false;
}

define('ROOT_PATH', $projectRoot . DIRECTORY_SEPARATOR);
define('IS_VENDOR_MODE', $isVendorMode);

// Define project paths
// SRC_PATH points to the project's src/ directory (where App\ namespace lives)
define('SRC_PATH', ROOT_PATH . 'src' . DIRECTORY_SEPARATOR);
define('CONFIG_PATH', SRC_PATH . 'App' . DIRECTORY_SEPARATOR . 'Config' . DIRECTORY_SEPARATOR);

require_once $projectRoot . '/vendor/autoload.php';

require_once $frameworkDir . '/cli/helpers/color.php';

// Available commands
$commands = [
    'new' => [
        'description' => 'Create new StoneScriptPHP project (like "ng new" for Angular)',
        'file' => 'cli/new.php',
    ],
    'init' => [
        'description' => 'Initialize StoneScriptPHP in existing project (after composer require)',
        'file' => 'cli/init.php',
    ],
    'setup' => [
        'description' => 'Interactive project setup (run after composer create-project). Use --quiet to skip prompts',
        'file' => 'cli/setup.php',
    ],
    'generate' => [
        'description' => 'Generate code (route, model, migration, etc.)',
        'file' => 'cli/generate-dispatcher.php',
    ],
    'migrate' => [
        'description' => 'Run database migrations',
        'file' => 'cli/migrate.php',
    ],
    'test' => [
        'description' => 'Run PHPUnit tests',
        'handler' => 'test',
    ],
    'env' => [
        'description' => 'Generate .env file',
        'file' => 'cli/generate-env.php',
    ],
    'cli-server' => [
        'description' => 'Start HTTP API server for code generation',
        'file' => 'cli/cli-server.php',
    ],
    'tenant' => [
        'description' => 'Manage multi-tenant databases (create, list, migrate, etc.)',
        'file' => 'cli/tenant.php',
    ],
    'seed' => [
        'description' => 'Seed database with initial data (seed rbac, etc.)',
        'file' => 'cli/seed.php',
    ],
    'create:admin' => [
        'description' => 'Create system administrator user',
        'file' => 'cli/create-admin.php',
    ],
    'schema:export' => [
        'description' => 'Export postgresql folder as tar.gz for db-gateway',
        'file' => 'cli/schema-export.php',
    ],
    'gateway:register-main' => [
        'description' => 'Register platform and create main database via gateway',
        'file' => 'cli/gateway-register-main.php',
    ],
    'gateway:register-tenant' => [
        'description' => 'Register platform and upload tenant schema to gateway',
        'file' => 'cli/gateway-register-tenant.php',
    ],
    'gateway:migrate-main' => [
        'description' => 'Migrate main database schema via gateway',
        'file' => 'cli/gateway-migrate-main.php',
    ],
    'gateway:migrate-tenant' => [
        'description' => 'Migrate tenant database schema via gateway',
        'file' => 'cli/gateway-migrate-tenant.php',
    ],
];

// Parse command
$command = $argv[1] ?? 'help';
$args = array_slice($argv, 2);

// Special handling for 'generate' with sub-commands
if ($command === 'generate' && !empty($args)) {
    $subCommand = $args[0];

    // Check if it's an auth command (auth:google, auth:linkedin, etc.)
    if (str_starts_with($subCommand, 'auth:')) {
        $commands['generate']['file'] = 'cli/generate-auth.php';
    } elseif (str_starts_with($subCommand, 'cache:')) {
        // Cache commands (cache:redis, etc.)
        if ($subCommand === 'cache:redis') {
            $commands['generate']['file'] = 'cli/generate-cache-redis.php';
        }
    } elseif ($subCommand === 'route' || str_starts_with($subCommand, 'route')) {
        $commands['generate']['file'] = 'cli/generate-route.php';
    } elseif ($subCommand === 'model') {
        $commands['generate']['file'] = 'cli/generate-model.php';
    } elseif ($subCommand === 'client') {
        $commands['generate']['file'] = 'cli/generate-client.php';
    } elseif ($subCommand === 'contract') {
        $commands['generate']['file'] = 'cli/generate-contract.php';
    } elseif ($subCommand === 'env') {
        $commands['generate']['file'] = 'cli/generate-env.php';
    } elseif ($subCommand === 'jwt') {
        $commands['generate']['file'] = 'cli/generate-jwt-keys.php';
    }
}

// Show help
if ($command === 'help' || $command === '--help' || $command === '-h') {
    echo Color::blue("StoneScriptPHP CLI Tool") . "\n\n";
    echo "Usage: php stone <command> [options]\n\n";
    echo "Available commands:\n";
    foreach ($commands as $cmd => $info) {
        printf("  %s%-12s%s %s\n", Color::GREEN, $cmd, Color::NC, $info['description']);
    }
    echo "\n";
    echo "Examples:\n";
    echo "  php stone new my-api                    # Create new project\n";
    echo "  php stone setup                         # Interactive setup\n";
    echo "  php stone generate route login          # Generate login route\n";
    echo "  php stone generate model get_user.pgsql # Generate model from PostgreSQL function\n";
    echo "  php stone generate contract             # Generate contracts from routes\n";
    echo "  php stone generate client               # Generate TypeScript client\n";
    echo "  php stone generate auth:google          # Generate Google OAuth\n";
    echo "  php stone generate cache:redis          # Generate Redis caching\n";
    echo "  php stone generate jwt                  # Generate JWT RSA keys\n";
    echo "  php stone migrate verify                # Check database drift\n";
    echo "  php stone tenant:create \"Acme\" acme    # Create new tenant\n";
    echo "  php stone tenant:list                   # List all tenants\n";
    echo "  php stone gateway:register-main          # Register platform + create main DB\n";
    echo "  php stone gateway:register-tenant        # Register platform + upload tenant schema\n";
    echo "  php stone gateway:migrate-main           # Migrate main database schema\n";
    echo "  php stone gateway:migrate-tenant          # Migrate all tenant database schemas\n";
    echo "\n";
    echo "Run 'php stone <command> --help' for detailed help on any command.\n";
    echo "\n";
    exit(0);
}

// Execute command
if (!isset($commands[$command])) {
    echo Color::red("Error: Unknown command '$command'") . "\n";
    echo "Run 'php stone help' for available commands\n";
    exit(1);
}

$cmdInfo = $commands[$command];

// Handle built-in commands
if (isset($cmdInfo['handler'])) {
    switch ($cmdInfo['handler']) {
        case 'test':
            if (!file_exists('vendor/bin/phpunit')) {
                echo Color::red("PHPUnit not installed. Run: composer require --dev phpunit/phpunit") . "\n";
                exit(1);
            }
            passthru("vendor/bin/phpunit " . implode(' ', $args));
            break;
    }
    exit(0);
}

// Execute external CLI script
if (isset($cmdInfo['file'])) {
    // CLI tools are in the framework package directory
    $scriptPath = $frameworkDir . '/' . $cmdInfo['file'];

    if (!file_exists($scriptPath)) {
        echo Color::red("Error: CLI script not found") . "\n\n";
        echo "Looking for: $scriptPath\n\n";
        echo "This usually means:\n";
        echo "  1. StoneScriptPHP framework is not installed\n";
        echo "  2. You need to run: composer install\n";
        echo "  3. Or update to latest version: composer update progalaxyelabs/stonescriptphp\n";
        exit(1);
    }

    // Pass arguments to the script
    // For 'generate' commands, skip the sub-command name (route, model, client, etc.)
    $scriptArgs = ($command === 'generate' && !empty($args)) ? array_slice($args, 1) : $args;
    $_SERVER['argv'] = array_merge([$scriptPath], $scriptArgs);
    $_SERVER['argc'] = count($_SERVER['argv']);

    require $scriptPath;
    exit(0);
}
