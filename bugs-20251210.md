# StoneScriptPHP Bug Report - December 10, 2025

## Bug #1: Undefined constant "Framework\STDERR" in Logger.php

**Severity:** Medium
**Status:** âœ… Fixed
**Affected Version:** v2.0.12
**Fixed Version:** v2.0.13
**Discovered:** 2025-12-10
**Fixed:** 2025-12-10 15:30 UTC
**Reporter:** ProGalaxy v3 API Migration Team
**Commit:** 6909184

### Description

The `Logger.php` class in the StoneScriptPHP framework throws an error when trying to write console output:

```
Uncaught Error: Undefined constant "Framework\STDERR" in /var/www/html/vendor/progalaxyelabs/stonescriptphp/Logger.php:228
```

### Root Cause

The Logger class is using `STDERR` and `STDOUT` constants without the global namespace prefix (`\`). Since the Logger class is in the `Framework` namespace, PHP tries to resolve these as `Framework\STDERR` and `Framework\STDOUT`, which don't exist.

**File:** `vendor/progalaxyelabs/stonescriptphp/Logger.php`
**Line:** 228

### Current Code (Buggy)

```php
namespace Framework;

// ...

private function write_to_console(string $level, string $message, string $timestamp, array $context = []): void
{
    // ...

    // Write to STDERR for errors, STDOUT for others
    $stream = in_array($level, [self::ERROR, self::CRITICAL, self::ALERT, self::EMERGENCY])
        ? STDERR  // BUG: PHP looks for Framework\STDERR (doesn't exist)
        : STDOUT; // BUG: PHP looks for Framework\STDOUT (doesn't exist)

    fwrite($stream, $output . PHP_EOL);
}
```

### Fixed Code (Our Implementation)

```php
namespace Framework;

// ...

private function write_to_console(string $level, string $message, string $timestamp, array $context = []): void
{
    // ...

    // Write to STDERR for errors, STDOUT for others
    $stream = in_array($level, [self::ERROR, self::CRITICAL, self::ALERT, self::EMERGENCY])
        ? \STDERR  // FIX: Use global STDERR constant
        : \STDOUT; // FIX: Use global STDOUT constant

    fwrite($stream, $output . PHP_EOL);
}
```

### Impact

- **Functional Impact:** Partial - The API still responds correctly, but error logging fails
- **User Impact:** Low - Only affects internal logging/debugging
- **Production Impact:** Medium - Stack traces are exposed in container logs instead of being properly logged

### Local Fix Applied

**Location:** ProGalaxy v3 API
**Path:** `/ssd2/projects/progalaxy-elabs/ed-tech/progalaxy/v3/api/vendor/progalaxyelabs/stonescriptphp/Logger.php:228`

**Fix Applied:** Added leading backslashes to `STDERR` and `STDOUT` constants to reference global namespace.

### Expected Framework Fix

We expect the StoneScriptPHP package maintainer to apply the same fix:
- Add `\` prefix to `STDERR` on line 228
- Add `\` prefix to `STDOUT` on line 229
- Potentially search for other missing global constant references in the codebase

### Steps to Reproduce

1. Create a new StoneScriptPHP project:
   ```bash
   composer create-project progalaxyelabs/stonescriptphp-server my-api
   ```

2. Configure `.env` with valid database credentials

3. Build Docker container with PHP 8.3-cli-bookworm

4. Start the server:
   ```bash
   php -S 0.0.0.0:9100 -t public
   ```

5. Make a request that triggers logging (e.g., any error or healthcheck failure)

6. Observe the error in logs:
   ```
   Uncaught Error: Undefined constant "Framework\STDERR"
   ```

### Environment

- **PHP Version:** 8.3.28
- **OS:** Debian Bookworm (Docker container)
- **Server:** PHP built-in development server
- **Framework:** StoneScriptPHP v2.0.12 (via progalaxyelabs/stonescriptphp-server)

### Related Files

- `vendor/progalaxyelabs/stonescriptphp/Logger.php`
- `vendor/progalaxyelabs/stonescriptphp/ExceptionHandler.php` (calls Logger)

### Notes

- This is a namespace resolution issue, common when using PHP predefined constants in namespaced code
- Other global constants in the framework should be audited (e.g., `STDIN`, `PHP_EOL`, etc.) - though `PHP_EOL` works because it's a string constant
- The bug doesn't prevent the API from functioning, but prevents proper error logging

### Action Items

- [x] Report bug to StoneScriptPHP GitHub repository
- [x] Create pull request with fix
- [x] Apply local fix in ProGalaxy v3 API project
- [x] Apply official fix to framework package
- [x] Commit fix (commit 6909184)
- [x] Ready for v2.0.13 release

### Official Fix

The bug has been fixed in the StoneScriptPHP framework package:

**Commit:** `6909184`
**File:** `Logger.php` lines 228-229
**Change:** Added `\` prefix to `STDERR` and `STDOUT` constants

```php
// Before (buggy)
? STDERR
: STDOUT;

// After (fixed)
? \STDERR
: \STDOUT;
```

**Release:** Will be available in v2.0.13

---

**Last Updated:** 2025-12-10 15:30 UTC
**Status:** Fixed and ready for release
