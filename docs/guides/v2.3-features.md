# StoneScriptPHP v2.3 New Features Guide

This guide covers the new features added in StoneScriptPHP v2.3.x.

---

## 1. Database Gateway Integration

StoneScriptPHP now supports two database connection modes:

| Mode | Use Case | How It Works |
|------|----------|--------------|
| **direct** | Simple projects, single database | Uses `pg_connect()` directly |
| **gateway** | Enterprise, multi-tenant platforms | HTTP calls to stonescriptdb-gateway |

### Configuration

```env
# Direct mode (default - no changes needed)
DB_CONNECTION_MODE=direct
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=secret
DATABASE_DBNAME=myapp

# Gateway mode (for multi-tenant deployments)
DB_CONNECTION_MODE=gateway
DB_GATEWAY_URL=http://localhost:9000
DB_GATEWAY_PLATFORM=myplatform
DB_GATEWAY_TENANT_ID=tenant_001
```

### Usage

The API is identical regardless of mode:

```php
// Works in both direct and gateway mode
$users = Database::fn('get_users', []);
$user = Database::fn('get_user_by_id', [123]);
```

### Checking Connection Mode

```php
if (Database::isGatewayMode()) {
    // Running in gateway mode
}

$mode = Database::getConnectionMode(); // 'direct' or 'gateway'
```

### Limitations in Gateway Mode

Raw SQL methods are only available in direct mode:

```php
// These throw exceptions in gateway mode
Database::internal_query('SELECT * FROM users');
Database::query('DELETE FROM cache WHERE expired < NOW()');
Database::copy_from($rows, 'bulk_import', "\t");
```

---

## 2. Database Helper: `result_as_single()`

New helper method for functions that return exactly one row.

### Before (workaround)

```php
$rows = Database::fn('get_user_by_id', [$id]);
$result = Database::result_as_table('get_user_by_id', $rows, UserModel::class);
$user = $result[0] ?? null;
```

### After (cleaner)

```php
$rows = Database::fn('get_user_by_id', [$id]);
$user = Database::result_as_single('get_user_by_id', $rows, UserModel::class);
```

### When to Use

| Method | Use Case |
|--------|----------|
| `result_as_single()` | Get by ID, create, update (returns one row or null) |
| `result_as_table()` | List queries (returns array of objects) |
| `result_as_object()` | Legacy - uses `o_` prefix for output params |

---

## 3. JWT Path Auto-Detection

The `JwtAuthMiddleware` now automatically handles URL prefix mismatches caused by nginx rewrites.

### The Problem

With nginx rewriting `/api/*` to `/index.php`:
- Browser requests: `POST /api/user/access`
- Internal route path: `/user/access`

Previously, developers had to figure out which path format to use for `excludedPaths`.

### The Solution

Now both formats work:

```php
$router->use(new JwtAuthMiddleware(
    jwtHandler: $jwtHandler,
    excludedPaths: [
        '/api/user/access',  // External URL - works
        '/user/access',      // Internal route - also works
    ]
));
```

The middleware auto-detects common prefixes (`/api`, `/v1`, `/v2`) and normalizes paths automatically.

---

## 4. Route/Service Separation

The code generator now produces separate Route and Service classes for better testability.

### Generate a Route

```bash
php stone generate route post /admin
```

### Generated Structure

```
src/App/
├── Routes/PostAdminRoute.php         # HTTP handling only
├── Services/PostAdminService.php     # Business logic
├── Contracts/IPostAdminService.php   # Service interface
├── DTO/PostAdminRequest.php          # Request DTO
└── DTO/PostAdminResponse.php         # Response DTO
```

### Route Class (extends BaseRoute)

```php
<?php

namespace App\Routes;

use StoneScriptPHP\BaseRoute;
use StoneScriptPHP\IRequest;
use StoneScriptPHP\IResponse;
use App\Services\PostAdminService;
use App\DTO\PostAdminRequest;

class PostAdminRoute extends BaseRoute
{
    private IPostAdminService $service;

    public function __construct()
    {
        $this->service = new PostAdminService();
    }

    public function validation_rules(): array
    {
        return [
            'email' => 'required|email',
            'name' => 'required|min:2|max:80',
        ];
    }

    protected function buildRequest(): IRequest
    {
        return new PostAdminRequest(
            email: $this->email,
            name: $this->name,
        );
    }

    protected function execute(IRequest $request): IResponse
    {
        return $this->service->execute($request);
    }
}
```

### Service Class (business logic)

```php
<?php

namespace App\Services;

use App\Contracts\IPostAdminService;
use App\DTO\PostAdminRequest;
use App\DTO\PostAdminResponse;
use App\Database\Functions\FnCreateAdmin;

class PostAdminService implements IPostAdminService
{
    public function execute(PostAdminRequest $request): PostAdminResponse
    {
        $result = FnCreateAdmin::run($request->email, $request->name);

        return new PostAdminResponse(
            admin_id: $result->admin_id
        );
    }
}
```

### DTOs (implement marker interfaces)

```php
// Request DTO
use StoneScriptPHP\IRequest;

class PostAdminRequest implements IRequest
{
    public function __construct(
        public readonly string $email,
        public readonly string $name,
    ) {}
}

// Response DTO
use StoneScriptPHP\IResponse;

class PostAdminResponse implements IResponse
{
    public function __construct(
        public readonly int $admin_id,
    ) {}
}
```

### Cross-Field Validation

Override `custom_validation()` for validation involving multiple fields:

```php
class PostOrderRoute extends BaseRoute
{
    public ?string $start_date = null;
    public ?string $end_date = null;

    public function validation_rules(): array
    {
        return [
            'start_date' => 'required|date',
            'end_date' => 'required|date',
        ];
    }

    protected function custom_validation(): string|array|null
    {
        if (strtotime($this->end_date) <= strtotime($this->start_date)) {
            return 'end_date must be after start_date';
        }
        return null;
    }

    // ... buildRequest(), execute()
}
```

### Testing Benefits

Services can be unit tested without HTTP:

```php
class PostAdminServiceTest extends TestCase
{
    public function test_creates_admin(): void
    {
        $request = new PostAdminRequest(
            email: 'admin@example.com',
            name: 'Test Admin'
        );

        $service = new PostAdminService();
        $response = $service->execute($request);

        $this->assertNotNull($response->admin_id);
    }
}
```

---

## 5. PostgreSQL Extensions (Setup Note)

Common PostgreSQL extensions that StoneScriptPHP applications often need:

```sql
-- Run once per database
CREATE EXTENSION IF NOT EXISTS pgcrypto;    -- gen_random_bytes(), encryption
CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; -- uuid_generate_v4()
CREATE EXTENSION IF NOT EXISTS pg_trgm;     -- Fuzzy text search
```

If you encounter errors like:
```
ERROR: function gen_random_bytes(integer) does not exist
```

Run the appropriate `CREATE EXTENSION` command.

---

## Migration from v2.2.x

### Breaking Changes

None. All changes are backward compatible.

### Recommended Updates

1. **Use `result_as_single()`** for single-row queries instead of `result_as_table()[0] ?? null`

2. **Use new route generator** for new routes - existing routes continue to work

3. **Consider gateway mode** if you're running multiple platform containers against shared PostgreSQL

---

## Summary

| Feature | Benefit |
|---------|---------|
| Gateway integration | Shared connection pool, multi-tenancy support |
| `result_as_single()` | Cleaner code for single-row queries |
| JWT path auto-detect | No more confusion about `/api/` prefix |
| Route/Service separation | Testable business logic, cleaner architecture |
